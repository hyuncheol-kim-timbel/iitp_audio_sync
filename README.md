# 오디오 동기화 프로그램

**버전 1.0.1** | Python 3.8+

두 개의 마이크로 수동 녹음한 오디오 파일들을 자동으로 동기화하는 프로그램입니다.

```bash
# 버전 확인
python audio_sync.py --version
python batch_process.py --version
```

## 개요

이 프로그램은 서로 다른 시간에 녹음을 시작한 두 마이크의 오디오를 동기화합니다:
- **기준 폴더**: JSON 전사 파일을 포함한 폴더 (예: `음성`)
- **대상 폴더**: 동기화할 폴더 (예: `음성_360`)

**지원 파일 형식**:
- `.wav` - 표준 WAV 파일
- `.aup3` - Audacity 3.0+ 프로젝트 파일 (자동 변환 지원)
  - **다채널 지원**: 8채널 .aup3 파일을 8개의 모노 WAV로 자동 분리
  - 각 채널이 독립적으로 동기화됨 (예: file_ch1.wav, file_ch2.wav, ...)

**고정밀 동기화 기술**:
- 박수 소리(임펄스) 자동 감지
- 10배 업샘플링을 통한 서브샘플 정확도
- 약 **0.1ms 단위**까지 정밀한 동기화 가능

두 오디오 간의 시간 차이를 자동으로 계산하고, 대상 폴더의 오디오를 기준 폴더에 맞춰 동기화합니다.

## 설치

### 1. Python 환경 준비

Python 3.8 이상이 필요합니다.

### 2. 의존성 설치

```bash
pip install -r requirements.txt
```

## 사용 방법

**중요 - Windows 사용자**: 모든 Python 스크립트는 `python` 명령어를 앞에 붙여서 실행해야 합니다.
- ✅ 올바름: `python audio_sync.py Test`
- ❌ 작동 안함: `audio_sync.py Test`

### 1. 부모 폴더 지정 (간편 - 권장)

음성, 음성_360 폴더가 특정 폴더 안에 있는 경우:

```bash
python audio_sync.py Test
```

이 경우 `Test/음성`, `Test/음성_360` 폴더를 자동으로 찾아서 처리하고, 결과는 `Test/음성_360_output`에 저장됩니다.

### 2. 기본 사용

현재 디렉토리에 `음성`, `음성_360` 폴더가 있는 경우:

```bash
python audio_sync.py
```

### 3. 폴더 직접 지정

```bash
python audio_sync.py --reference 음성 --target 음성_360
```

또는 전체 경로 지정:

```bash
python audio_sync.py --reference C:/path/to/음성 --target C:/path/to/음성_360
```

### 4. 여러 폴더 배치 처리 (추천) - 유연한 구조 지원

**새로운 기능**: 임의의 폴더 구조를 자동으로 탐색하여 `프로젝트` + `음성_360` 패턴의 폴더 쌍을 찾아 처리합니다.

**사용법 (중요)**:

```bash
# Windows (명령 프롬프트/PowerShell)
python batch_process.py Test

# 또는 간편하게 (Windows 전용 배치 파일)
batch_process.bat Test

# Linux/Mac
python batch_process.py Test

# 로그 파일 없이 실행 (콘솔 출력만)
python batch_process.py Test --no-log
```

**주의**: Windows에서 `batch_process.py Test`로 직접 실행하면 작동하지 않습니다.
반드시 `python`을 앞에 붙이거나 `batch_process.bat`를 사용하세요.

**기본 사용**:
```bash
# 현재 디렉토리 전체를 탐색
python batch_process.py

# 특정 디렉토리만 탐색
python batch_process.py Test
```

**지원하는 폴더 구조 예시**:
```
Test/
  ├── audio1/
  │   ├── audio1/          # 기준 (JSON 포함)
  │   └── audio1_360/      # 대상
  ├── Test2/
  │   ├── Test2/           # 기준 (JSON 포함)
  │   └── Test2_360/       # 대상
  └── 음성/
      └── 음성_360/
```

**주요 기능**:
- **재귀 탐색**: 지정된 디렉토리 하위를 모두 탐색
- **패턴 매칭**: `{name}` 및 `{name}_360` 형태의 폴더 쌍 자동 감지
- **JSON 기반 판단**: JSON 파일이 있는 폴더를 자동으로 기준 폴더로 설정
- **유연한 구조**: 폴더 이름이나 위치에 관계없이 처리 가능
- **배치 처리**: 찾은 모든 폴더 쌍을 순차 처리
- **오류 허용**: 하나의 폴더에서 오류가 발생해도 계속 진행

**실행 예시**:
```
$ python batch_process.py Test
================================================================================
오디오 동기화 배치 처리 프로그램 (유연한 구조)
================================================================================
탐색 디렉토리: C:\...\Test
패턴: {name} + {name}_360 폴더 쌍
================================================================================

[검색] 폴더 쌍 검색 중...
[발견] 3개의 폴더 쌍을 찾았습니다:

  1. Test/
     - 기준: 음성 (3개 WAV)
     - 대상: 음성_360 (3개 WAV)
  2. Test\audio1/
     - 기준: audio1 (3개 WAV)
     - 대상: audio1_360 (3개 WAV)
  3. Test\Test2/
     - 기준: Test2 (3개 WAV)
     - 대상: Test2_360 (3개 WAV)

총 3개의 폴더 쌍을 처리합니다.
계속하시겠습니까? (y/n): y
...
```

### 주요 옵션

**audio_sync.py 옵션**:
- `parent_dir`: 부모 폴더 경로 (선택사항)
  - 예: `python audio_sync.py Test` → `Test/음성`, `Test/음성_360` 처리
- `--reference`: 기준 폴더 경로 (JSON 파일 포함) - 직접 지정
- `--target`: 동기화할 대상 폴더 경로 - 직접 지정
- `--sync-duration`: 동기화 분석에 사용할 오디오 길이 (초, 기본값: 10)
- `--sample-rate`: 동기화 분석용 샘플링 레이트 (Hz, 기본값: 16000)
  - **주의**: 이 값은 분석에만 사용되며, 출력 파일은 원본 파일의 샘플링 레이트를 유지합니다

**batch_process.py 옵션**:
- `base_dir`: 탐색할 기본 디렉토리 (기본값: 현재 디렉토리)
- `--no-log`: 로그 파일 생성 안 함 (콘솔 출력만)

### 5. Audacity .aup3 파일 변환 (독립 실행)

`.aup3` 파일은 동기화 시 자동으로 처리되지만, 필요시 독립적으로 WAV로 변환할 수도 있습니다:

```bash
# 단일 파일 변환
python aup3_converter.py input.aup3 output.wav

# 디렉토리 내 모든 .aup3 파일 변환
python aup3_converter.py input_folder output_folder --batch

# 하위 디렉토리까지 재귀적으로 변환
python aup3_converter.py input_folder output_folder --batch --recursive
```

**참고**: 일반적으로 이 단계는 불필요합니다. `audio_sync.py`와 `batch_process.py`가 .aup3 파일을 자동으로 처리합니다.

### 6. Audacity 다채널 .aup3 파일 동기화

8채널 .aup3 파일을 동기화하는 경우:

```bash
python audio_sync.py --reference 음성 --target 음성_360
```

**처리 과정**:
1. .aup3 파일 감지
2. 각 파일을 8개의 모노 WAV로 자동 분리
   - `file_ch1.wav`, `file_ch2.wav`, ..., `file_ch8.wav`
3. 같은 채널끼리 매칭 (ch1 ↔ ch1, ch2 ↔ ch2, ...)
4. 각 채널 쌍 독립적으로 동기화
5. 결과를 `{폴더}_output`에 저장

**설정 옵션** (`config.py`):
```python
# 모든 채널 추출 (기본값: True)
AUP3_EXTRACT_ALL_TRACKS = True

# 동기화 방식 (기본값: "first")
# "first": 첫 채널로 오프셋 계산, 모든 채널에 적용 (빠름, 권장)
# "all": 각 채널마다 오프셋 계산 (느림, 더 정확)
AUP3_SYNC_MODE = "first"
```

## 파일 구조

### 입력 예시 1: 현재 디렉토리

```
samples/
├── 음성/                           # 기준 폴더 (JSON 포함)
│   ├── VID_20250619_171147_00_001.wav
│   ├── VID_20250619_171147_00_001_sp.json
│   ├── VID_20250619_174114_00_002.wav
│   ├── VID_20250619_174114_00_002_sp.json
│   └── ...
└── 음성_360/                       # 대상 폴더
    ├── LRV_20250619_171147_11_001.wav
    ├── LRV_20250619_174114_11_002.wav
    └── ...
```

실행: `python audio_sync.py`

### 입력 예시 2: 부모 폴더 사용 (권장)

```
samples/
└── Test/                           # 부모 폴더
    ├── 음성/                       # 기준 폴더 (JSON 포함)
    │   ├── VID_20250619_171147_00_001.wav
    │   ├── VID_20250619_171147_00_001_sp.json
    │   └── ...
    └── 음성_360/                   # 대상 폴더
        ├── LRV_20250619_171147_11_001.wav
        └── ...
```

실행: `python audio_sync.py Test`

### 출력

```
samples/
└── 음성_360_output/                # 동기화된 결과
    ├── LRV_20250619_171147_11_001.wav
    ├── LRV_20250619_174114_11_002.wav
    └── ...
```

또는 부모 폴더를 사용한 경우:

```
samples/
└── Test/
    └── 음성_360_output/            # 동기화된 결과
        ├── LRV_20250619_171147_11_001.wav
        └── ...
```

## 원본 파일 속성 보존

**중요**: 출력 파일은 원본 대상 파일의 모든 속성을 그대로 유지합니다.

- **샘플링 레이트**: 원본 파일의 샘플링 레이트 유지 (예: 16000Hz → 16000Hz)
- **양자화 비트 깊이**: 원본 파일의 양자화 유지 (예: PCM_16 → PCM_16)
- **채널 수**: 모노/스테레오 속성 유지 (예: 모노 → 모노, 스테레오 → 스테레오)

분석용 샘플링 레이트는 두 파일을 비교할 때만 사용되며, 최종 출력 파일에는 영향을 주지 않습니다.

## 동작 원리

1. **파일 매칭**: 파일 이름의 인덱스를 기준으로 대응되는 파일 쌍을 찾습니다
   - 예: `VID_*_001.wav` ↔ `LRV_*_001.wav`

2. **정밀 오프셋 계산**: 각 파일 쌍의 초기 N초를 분석하여 시간 차이를 정밀하게 계산합니다

   **2-1. 임펄스(박수 소리) 감지**:
   - 에너지 급증 지점을 자동으로 감지하여 박수 위치를 찾습니다
   - 각 오디오에서 임펄스 위치를 밀리초 단위로 감지
   - 감지된 임펄스 주변 1초 구간만 추출하여 효율적으로 분석

   **2-2. 고정밀 분석**:
   - 추출한 구간을 10배 업샘플링하여 서브샘플 정확도 달성
   - Cross-correlation으로 최적의 동기화 지점 계산
   - 원본 샘플링 레이트 기준으로 오프셋 변환

   **정확도**: 업샘플링을 통해 약 **0.1ms 단위**까지 정밀한 동기화 가능

3. **동기화 적용** (원본 샘플링 레이트 기준으로 변환):
   - 대상이 늦게 시작한 경우: 앞에 무음 추가
   - 대상이 일찍 시작한 경우: 앞부분 제거

4. **결과 저장**: 동기화된 오디오를 원본 속성 그대로 `{대상폴더}_output`에 저장

### 박수 소리(임펄스) 요구사항

- 두 오디오 모두 녹음 시작 후 **10초 이내**에 박수를 쳐야 합니다 (설정 변경 가능)
- 박수는 명확하고 큰 소리여야 자동 감지가 정확합니다

**임펄스 미감지 시 동작:**
- 임펄스가 감지되지 않으면 경고 메시지 출력
- 자동으로 전체 분석 구간(SYNC_DURATION)을 사용하여 동기화 시도
- 정확도가 임펄스 기반보다 낮을 수 있으므로 박수를 치는 것을 권장

## 설정 파일

`config.py` 파일에서 기본 설정을 변경할 수 있습니다:

```python
# 동기화에 사용할 초기 오디오 길이 (초)
# 박수 소리(임펄스)가 이 구간 내에 있어야 합니다
SYNC_DURATION = 10

# 동기화 분석용 샘플링 레이트 (Hz)
# 출력 파일은 원본 파일의 샘플링 레이트를 유지합니다
# 높을수록 정확하지만 처리 속도가 느려집니다
SAMPLE_RATE = 16000

# 정밀 동기화 설정
# 업샘플링 배율 (높을수록 정확하지만 느림, 권장: 10)
UPSAMPLE_FACTOR = 10

# 임펄스 감지 임계값 계수 (평균 에너지의 몇 배, 권장: 3.0)
IMPULSE_THRESHOLD = 3.0

# 출력 폴더 접미사
OUTPUT_SUFFIX = "_output"

# 폴더 경로 설정
AUDIO_FOLDERS = {
    "reference": "음성",
    "target": "음성_360"
}

# .aup3 다채널 처리 설정
# True: .aup3 파일의 모든 트랙을 개별 WAV 파일로 추출
# False: 첫 번째 트랙만 추출
AUP3_EXTRACT_ALL_TRACKS = True

# .aup3 다채널 동기화 방식
# "all": 모든 채널을 독립적으로 동기화 (각 채널마다 오프셋 계산)
# "first": 첫 번째 채널로 오프셋 계산 후 모든 채널에 동일하게 적용 (권장)
AUP3_SYNC_MODE = "first"
```

### 고급 설정 조정

- **UPSAMPLE_FACTOR**: 업샘플링 배율
  - 10 (기본): 약 0.1ms 정확도, 빠른 처리
  - 20: 약 0.05ms 정확도, 느린 처리
  - 5: 약 0.2ms 정확도, 매우 빠른 처리

- **IMPULSE_THRESHOLD**: 임펄스 감지 민감도
  - 3.0 (기본): 보통 민감도
  - 2.0: 더 민감하게 감지 (조용한 박수도 감지)
  - 4.0: 덜 민감하게 감지 (큰 박수만 감지)

- **SYNC_DURATION**: 분석 구간 길이
  - 10초 (기본): 박수가 10초 이내에 있어야 함
  - 15초: 박수가 늦게 친 경우
  - 5초: 박수를 바로 친 경우 (빠른 처리)

## 로그 시스템

배치 처리 프로그램(`batch_process.py`)은 자동으로 상세한 로그를 파일로 기록합니다.

### 로그 파일 위치

로그 파일은 `logs/` 디렉토리에 타임스탬프와 함께 저장됩니다:

```
samples/
├── logs/
│   ├── batch_process_20251120_143022.log
│   ├── batch_process_20251120_150145.log
│   └── ...
```

### 로그 내용

로그 파일에는 다음 정보가 상세히 기록됩니다:

1. **작업 폴더**: 처리하는 각 폴더 경로
2. **작업 파일**: 처리하는 .aup3 파일 및 WAV 파일
3. **수정한 자막 파일**: 타임스탬프가 조정된 JSON 파일
4. **처리 시간**: 각 파일 및 폴더의 처리 소요 시간
5. **오프셋 정보**: 계산된 동기화 오프셋 (초 및 샘플 단위)
6. **채널 처리 정보**: 각 채널의 동기화 상태
7. **오류 정보**: 발생한 오류 및 실패 이유
8. **처리 결과**: 성공/실패/건너뜀 통계

### 로그 예시

```
2025-11-20 14:30:22 | INFO     | ======================================================================
2025-11-20 14:30:22 | INFO     | 오디오 동기화 배치 처리 (7채널)
2025-11-20 14:30:22 | INFO     | ======================================================================
2025-11-20 14:30:22 | INFO     | 시작 시간: 2025-11-20 14:30:22
2025-11-20 14:30:22 | INFO     | 로그 파일: logs/batch_process_20251120_143022.log
2025-11-20 14:30:22 | INFO     | ======================================================================
2025-11-20 14:30:22 | INFO     | 작업 폴더: Test\Sample1
2025-11-20 14:30:22 | INFO     |   - 프로젝트: 프로젝트 (3개 .aup3)
2025-11-20 14:30:22 | INFO     |   - 음성_360: 음성_360 (3개 WAV)
2025-11-20 14:30:23 | INFO     | [1/3] VID_20250619_171147_00_001
2025-11-20 14:30:23 | INFO     |   .aup3: VID_20250619_171147_00_001.aup3
2025-11-20 14:30:23 | INFO     |   WAV: LRV_20250619_171147_11_001.wav
2025-11-20 14:30:23 | INFO     |     → 오프셋: 0.125초 (2000 샘플)
2025-11-20 14:30:25 | INFO     |     → JSON 파일 발견: VID_20250619_171147_00_001_sp.json
2025-11-20 14:30:25 | INFO     |     → 타임스탬프에 오프셋 -0.125초 적용 중...
2025-11-20 14:30:25 | INFO     |   [완료] 파일 처리 완료 (소요 시간: 2.3초)
2025-11-20 14:30:30 | INFO     | [완료] 폴더 쌍 처리 성공 (7.8초)
2025-11-20 14:30:30 | INFO     | ======================================================================
2025-11-20 14:30:30 | INFO     | 처리 완료 요약
2025-11-20 14:30:30 | INFO     | ======================================================================
2025-11-20 14:30:30 | INFO     | 총 처리: 1개 폴더 쌍
2025-11-20 14:30:30 | INFO     |   - 성공: 1개
2025-11-20 14:30:30 | INFO     |   - 실패: 0개
2025-11-20 14:30:30 | INFO     |   - 건너뜀: 0개
2025-11-20 14:30:30 | INFO     | 전체 소요 시간: 8.1초
```

### 로그 레벨

- **INFO**: 일반 진행 상황 및 결과 (콘솔 및 파일에 기록)
- **WARNING**: 경고 메시지 (JSON 파일 없음 등)
- **ERROR**: 오류 발생
- **DEBUG**: 상세 디버깅 정보 (파일에만 기록)

### 로그 비활성화

로그 파일을 생성하지 않고 콘솔 출력만 보려면 `--no-log` 옵션을 사용하세요:

```bash
python batch_process.py Test --no-log
```

### 로그 활용

로그 파일을 확인하여:
- 처리하지 못한 파일 확인
- 실패 원인 파악
- 처리 시간 분석
- 재처리가 필요한 항목 식별

예를 들어, 로그에서 "오류" 또는 "경고"를 검색하여 문제가 있는 파일을 빠르게 찾을 수 있습니다.

## 파일 설명

### 메인 프로그램
- `audio_sync.py`: 단일 폴더 처리 프로그램
- `batch_process.py`: 여러 폴더 배치 처리 프로그램 (유연한 구조 지원)
- `batch_process.bat`: Windows용 배치 파일 래퍼
- `sync_logic.py`: 오디오 동기화 핵심 로직 (임펄스 감지, 업샘플링)
- `config.py`: 설정 파일
- `logger_utils.py`: 로그 시스템 유틸리티

### 변환 도구
- `aup3_converter.py`: Audacity .aup3 파일을 WAV로 변환하는 모듈
  - 독립 실행 가능
  - 동기화 프로그램에 자동 통합됨

### 유틸리티
- `check_audio_info.py`: 오디오 파일 속성 확인 도구
- `verify_output.py`: 출력 파일 속성 검증 도구

### 기타
- `requirements.txt`: Python 의존성 목록
- `README.md`: 사용 설명서

## 요구사항

- Python 3.8+
- numpy
- scipy
- librosa
- soundfile

## 주의사항

- 발화자가 고정된 위치에서 발화했다고 가정합니다
- 녹음 중 딜레이가 변경되지 않는다고 가정합니다
- 파일 이름 형식: `{PREFIX}_{DATE}_{TIME}_{ID}_{INDEX}.wav`
- 동일한 인덱스를 가진 파일들이 같은 내용을 녹음한 것으로 간주됩니다

## 버전 정보

**현재 버전: 1.0.1** (2025-11-20)

### 주요 기능
- ✅ 임펄스(박수) 자동 감지
- ✅ 10배 업샘플링 고정밀 동기화 (약 0.1ms 정확도)
- ✅ 원본 파일 속성 완벽 보존
- ✅ 유연한 폴더 구조 지원
- ✅ 재귀적 배치 처리
- ✅ Windows 배치 파일 지원
- ✅ Audacity .aup3 파일 자동 변환 및 처리
- ✅ 다채널 오디오 지원 (7채널 → 7개 모노 WAV 자동 분리)
- ✅ **상세 로그 시스템** (작업 폴더, 파일, 처리 시간, 오류 기록)

### 변경 이력
자세한 변경 이력은 [CHANGELOG.md](CHANGELOG.md)를 참조하세요.
