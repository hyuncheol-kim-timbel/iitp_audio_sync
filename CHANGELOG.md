# Changelog

모든 주요 변경 사항이 이 파일에 기록됩니다.

## [1.0.2] - 2025-12-08

### 추가됨
- **aup3 파싱 실패 시 Fallback 로직**
  - `.aup3` 파일이 손상된 경우 `음성/` 폴더의 WAV 파일로 자동 대체
  - 7채널 동기화는 건너뛰고 `음성_output`만 생성
- **.sync 파일 쌍 지원**: 파일별 수동 힌트 기능
  - 프로젝트 폴더와 음성_360 폴더에 각각 .sync 파일 생성 가능
  - 파일 인덱스 기반 자동 감지 (`VID_*_001.sync`, `LRV_*_001.sync`)
  - 이중 힌트 사용 시 검색 없이 힌트 위치 직접 사용
  - .sync 파일 형식: 초 단위 시간 (예: `02.915`)
- **--only-with-sync 옵션**
  - `audio_sync.py`: .sync 쌍이 있는 파일만 처리
  - `batch_process.py`: .sync 쌍이 있는 폴더만 처리
  - 효율적인 재처리 워크플로우: 전체 실행 → 실패 확인 → .sync 생성 → 재처리

### 개선됨
- **로그 시스템 간소화**
  - correlation 경고 제거 (사용자가 파형으로 직접 확인)
  - `failed_files.txt` 생성 제거
  - 모든 오류는 logs 폴더에 기록
  - 작업 폴더가 깔끔하게 유지됨

### 수정됨
- **샘플 레이트 변환 버그 수정**
  - 이중 힌트 사용 시 샘플 레이트 이중 변환 문제 해결
  - 분석 샘플 레이트(16000Hz)로 반환하도록 수정
  - 오프셋 계산 정확도 향상

### 워크플로우
```bash
# 1단계: 전체 동기화
python batch_process.py "path/to/data"

# 2단계: 실패 확인 및 .sync 파일 쌍 생성
# - 프로젝트 폴더: VID_*_001.sync
# - 음성_360 폴더: LRV_*_001.sync

# 3단계: .sync 쌍이 있는 항목만 재처리
python batch_process.py "path/to/data" --only-with-sync
```

## [1.0.1] - 2025-11-20

### 추가됨
- **상세 로그 시스템**: 배치 처리 과정의 모든 정보를 파일로 기록
  - 작업 폴더 및 파일 정보 기록
  - 처리 시간 측정 및 기록
  - 오프셋 정보 및 Trim 범위 기록
  - 수정한 JSON 파일 정보 기록
  - 오류 발생 시 상세한 오류 메시지 및 스택 트레이스 기록
  - 처리 통계 (성공/실패/건너뜀) 요약
- **로그 유틸리티**: `logger_utils.py` 모듈 추가
  - 타임스탬프 기반 로그 파일 자동 생성 (`logs/` 디렉토리)
  - INFO, WARNING, ERROR, DEBUG 레벨 지원
  - 파일과 콘솔 동시 출력
- **로그 제어 옵션**: `--no-log` 옵션으로 로그 비활성화 가능
- **로그 전달**: `batch_process.py`에서 `audio_sync.py`로 로그 파일 경로 전달

### 개선됨
- `audio_sync.py`: 모든 print 문을 logging으로 변경
- `batch_process.py`: 상세 로그 기록 기능 통합
- `README.md`: 로그 시스템 사용법 및 예시 추가
- 오류 발생 시 더욱 상세한 디버깅 정보 제공

### 파일 변경
- `logger_utils.py` (새 파일): 로그 시스템 유틸리티 클래스
- `audio_sync.py`: 로그 기능 통합 및 `--log-file` 옵션 추가
- `batch_process.py`: 로그 기능 통합 및 `--no-log` 옵션 추가
- `README.md`: 로그 시스템 섹션 추가

## [1.0.0] - 2025-11-15

### 추가됨
- **고정밀 오디오 동기화**: 임펄스(박수 소리) 자동 감지 기능
- **업샘플링 기반 동기화**: 10배 업샘플링으로 약 0.1ms 단위 정밀도
- **원본 속성 보존**: 샘플링 레이트, 양자화, 채널 수 완벽 보존
- **유연한 폴더 구조 지원**: `{name}` + `{name}_360` 패턴 자동 감지
- **재귀적 배치 처리**: 중첩된 폴더 구조 자동 탐색 및 처리
- **JSON 기반 자동 판단**: JSON 파일 유무로 기준 폴더 자동 설정
- **Windows 배치 파일**: `batch_process.bat` 편의 스크립트
- **버전 확인**: `--version` 옵션으로 버전 확인 가능

### 핵심 기능
1. **임펄스 감지 알고리즘**
   - 에너지 급증 지점 자동 감지 (10ms 윈도우)
   - 임계값 기반 박수 소리 위치 추출
   - 임펄스 주변 1초 구간만 분석하여 효율성 향상

2. **고정밀 동기화**
   - scipy.signal.resample을 이용한 업샘플링
   - Cross-correlation으로 서브샘플 정확도 달성
   - 원본 샘플링 레이트로 오프셋 변환

3. **원본 파일 속성 보존**
   - soundfile.info()로 원본 속성 읽기
   - 샘플링 레이트, subtype, 채널 수 유지
   - 분석은 공통 샘플링 레이트로, 출력은 원본 그대로

4. **배치 처리 시스템**
   - os.walk()를 이용한 재귀적 폴더 탐색
   - 폴더 쌍 자동 매칭 (`{name}`, `{name}_360`)
   - JSON 파일 기반 기준/대상 폴더 자동 판단
   - 오류 발생 시에도 다음 폴더 계속 처리

### 프로그램 구조
- `audio_sync.py`: 단일 폴더 처리 (4.9KB)
- `batch_process.py`: 배치 처리 (9.1KB)
- `batch_process.bat`: Windows 래퍼
- `sync_logic.py`: 동기화 핵심 로직 (9.3KB)
- `config.py`: 설정 파일 (935B)
- `check_audio_info.py`: 오디오 속성 확인 도구
- `verify_output.py`: 출력 검증 도구

### 설정 가능 항목
- `SYNC_DURATION`: 분석 구간 길이 (기본: 10초)
- `SAMPLE_RATE`: 분석용 샘플링 레이트 (기본: 16000Hz)
- `UPSAMPLE_FACTOR`: 업샘플링 배율 (기본: 10)
- `IMPULSE_THRESHOLD`: 임펄스 감지 임계값 (기본: 3.0)

### 의존성
- Python 3.8+
- numpy >= 1.24.0
- scipy >= 1.10.0
- librosa >= 0.10.0
- soundfile >= 0.12.0

### 알려진 제한사항
- 박수 소리는 설정된 SYNC_DURATION 내에 있어야 함
- 두 마이크 간 녹음 딜레이가 일정하다고 가정
- Windows에서 .bat 파일은 한글 주석 미지원
